name: main

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    CARGO_TERM_COLOR: always

jobs:
    changes:
        runs-on: ubuntu-latest
        outputs:
            src: ${{ steps.filter.outputs.src }}
            testbed: ${{ steps.filter.outputs.testbed }}
        steps:
            - uses: actions/checkout@v6
            - uses: dorny/paths-filter@v3
              id: filter
              with:
                  filters: |
                      src:
                        - 'crates/**'
                        - 'packages/rapier-2d/**'
                        - 'packages/rapier-3d/**'
                        - 'Cargo.toml'
                        - 'Cargo.lock'
                        - 'pnpm-lock.yaml'
                      testbed:
                        - 'packages/testbed2d/**'
                        - 'packages/testbed3d/**'

    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v6
              with:
                  node-version: "24"
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - name: Check formatting
              run: pnpm fmt --check
            - name: Lint
              run: pnpm lint
            - name: Check Rust formatting
              run: cargo fmt -- --check

    build:
        runs-on: ubuntu-latest
        needs: [changes]
        if: needs.changes.outputs.src == 'true' || needs.changes.outputs.testbed == 'true'
        env:
            RUSTFLAGS: -D warnings
        steps:
            - uses: actions/checkout@v6
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v6
              with:
                  node-version: "24"
                  cache: "pnpm"
            - uses: actions/cache@v5
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
            - run: pnpm install --frozen-lockfile
            - name: Build WASM and TypeScript
              run: pnpm build
            - name: Typecheck
              run: pnpm typecheck
            - name: Install wabt
              run: sudo apt-get install -y wabt
            - name: Check 2D SIMD build contains SIMD instructions
              run: |
                  if ! wasm-objdump -d packages/rapier-2d/wasm/release-simd/rapier_wasm_2d_bg.wasm | grep ':\sfd' ; then
                    echo "ERROR: 2D SIMD build does not include SIMD opcode prefix." >&2
                    exit 1
                  fi
            - name: Check 3D SIMD build contains SIMD instructions
              run: |
                  if ! wasm-objdump -d packages/rapier-3d/wasm/release-simd/rapier_wasm_3d_bg.wasm | grep ':\sfd' ; then
                    echo "ERROR: 3D SIMD build does not include SIMD opcode prefix." >&2
                    exit 1
                  fi
            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts
                  path: |
                      packages/rapier-2d/dist
                      packages/rapier-2d/wasm
                      packages/rapier-3d/dist
                      packages/rapier-3d/wasm
                  retention-days: 1

    benchmark:
        runs-on: ubuntu-latest
        needs: [changes, build]
        if: github.event_name == 'pull_request' && needs.changes.outputs.src == 'true'
        permissions:
            pull-requests: write
        steps:
            - uses: actions/checkout@v6
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v6
              with:
                  node-version: "24"
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts
                  path: packages
            - name: Run benchmarks
              id: bench
              run: |
                  pnpm bench:quick --no-compare 2>&1 | tee bench-output.txt

                  # Find the latest results file
                  RESULTS_FILE=$(ls -t packages/benchmarks/results/3d-*.json | head -1)
                  echo "results_file=$RESULTS_FILE" >> $GITHUB_OUTPUT

                  # Generate markdown table from results
                  node -e "
                  const fs = require('fs');
                  const data = JSON.parse(fs.readFileSync('$RESULTS_FILE', 'utf-8'));

                  function formatTime(ms) {
                    if (ms < 0.001) return (ms * 1000000).toFixed(0) + 'ns';
                    if (ms < 1) return (ms * 1000).toFixed(1) + 'µs';
                    return ms.toFixed(3) + 'ms';
                  }

                  let md = '## ⚡ Benchmark Results\n\n';
                  md += '| Benchmark | Mean | Min | Max |\n';
                  md += '|-----------|------|-----|-----|\n';

                  for (const r of data.results) {
                    md += '| ' + r.name + ' | ' + formatTime(r.mean) + ' | ' + formatTime(r.min) + ' | ' + formatTime(r.max) + ' |\n';
                  }

                  md += '\n<details>\n<summary>Environment</summary>\n\n';
                  md += '- **Node:** ' + data.node + '\n';
                  md += '- **Platform:** ' + data.platform + '/' + data.arch + '\n';
                  md += '- **Runner:** ubuntu-latest\n';
                  md += '- **Timestamp:** ' + data.timestamp + '\n';
                  md += '</details>\n';

                  fs.writeFileSync('benchmark-comment.md', md);
                  "
            - name: Post or update PR comment
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const body = fs.readFileSync('benchmark-comment.md', 'utf-8');
                      const marker = '<!-- rapier-benchmark-comment -->';
                      const fullBody = marker + '\n' + body;

                      const { data: comments } = await github.rest.issues.listComments({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: context.issue.number,
                      });

                      const existing = comments.find(c => c.body.includes(marker));

                      if (existing) {
                        await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: existing.id,
                          body: fullBody,
                        });
                        console.log('Updated existing benchmark comment');
                      } else {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: fullBody,
                        });
                        console.log('Created new benchmark comment');
                      }

    deploy-testbed:
        runs-on: ubuntu-latest
        needs: [changes, build]
        if: |
            github.event_name == 'push' &&
            github.ref == 'refs/heads/master' &&
            (needs.changes.outputs.src == 'true' || needs.changes.outputs.testbed == 'true')
        strategy:
            matrix:
                include:
                    - name: testbed2d
                      package: rapier-testbed2d
                      project-id: VERCEL_PROJECT_ID_TESTBED2D
                    - name: testbed3d
                      package: rapier-testbed3d
                      project-id: VERCEL_PROJECT_ID_TESTBED3D
        steps:
            - uses: actions/checkout@v6
            - uses: pnpm/action-setup@v4
              with:
                  version: 10
            - uses: actions/setup-node@v6
              with:
                  node-version: "24"
                  cache: "pnpm"
            - run: pnpm install --frozen-lockfile
            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build-artifacts
                  path: packages
            - name: Build testbed
              run: pnpm --filter ${{ matrix.package }} build
            - name: Deploy to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets[matrix.project-id] }}
                  vercel-args: "--prod"
                  working-directory: packages/${{ matrix.name }}
